# 📑 工程日志：阶段 3 - SITL 物理引擎深度优化与数据可视化闭环

**日期：** 2025年12月
**状态：** ✅ 完成
**目标：** 在纯 SITL 环境中实现可信的变构物理模拟，并建立自动化数据分析体系。

### 1. SITL 物理引擎的“暴力劫持” (Physics Engine Hijack)
回归纯代码环境后，我们通过修改 C++ 源码实现了物理层的变构模拟。

*   **权限破解：**
    *   修改 `SIM_Frame.h`，将 `Motor` 类的 `thrust_vector` 成员从 `private` 强行改为 `public`，允许外部逻辑直接干预推力方向。
*   **逻辑注入 (The Hard Hack)：**
    *   在 `SIM_Frame.cpp` 的 `update_forces` 主循环中植入代码。
    *   **逻辑：** 实时读取 Servo 9 PWM 值 -> 计算旋转矩阵 -> 每一帧强制覆盖电机的 `thrust_vector`。
*   **调试探针：**
    *   利用 `hal.console->printf` 和 `fprintf(stderr)` 实现了双通道日志输出。
    *   **关键验证：** 打印出 `Vector_Z` (垂直推力分量)。观测到当 PWM=1900 时，Z 分量从 -1.0 变为 0.0，且总推力模长 `Thrust_Mag` 保持为 1.0。
    *   **物理结论：** 确认了飞机的坠落是由**推力矢量偏转**引起的，而非动力丧失。

### 2. 自动化数据分析工具链 (Data Analysis Toolchain)
为了弥补失去 3D 画面的缺陷，我们开发了一套数据分析工具，用曲线图证明实验结果。

*   **日志解析器 (C++):**
    *   开发 `tools/wuk_log_parser.cpp`。
    *   功能：从 ArduPilot 的 DataFlash 日志（.BIN/.LOG）中提取 `RCOU` (电机输出)、`POS` (位置)、`ATT` (姿态) 等关键数据流，导出为 CSV 格式。
*   **可视化脚本 (Python):**
    *   开发 `tools/wuk_plot.py`，基于 `matplotlib` 和 `pandas`。
    *   **算法降噪：** 引入**滑动平均滤波 (Moving Average)** 算法，消除了仿真环境中风力干扰引起的高频电机抖动噪声。
    *   **图表输出：** 自动生成包含“变构指令 vs 垂直速度”、“推力矢量变化”、“高度骤降曲线”的组合图表。

### ✅ 阶段成果
- [x] 在不依赖 Gazebo 的情况下，在 SITL 内部成功模拟了变构物理特性。
- [x] 验证了“受控坠毁”的物理真实性。
- [x] 建立了一键式“仿真 -> 解析 -> 绘图”的自动化测试闭环。

---