

# 📑 工程日志：阶段 1 - 开发环境搭建与架构确立

**日期：** 2025年11月
**负责：** qihangyang
**目标：** 建立 ArduPilot 源码级开发环境，为实现“空中变构”功能奠定基础。

### 1. 技术架构定义 (Architecture Definition)
*   **控制方案变更：**
    *   从 V1 版本的脚本/外挂逻辑控制，转向 **ArduPilot 固件源码深度开发**。
    *   **目的：** 解决空中变构过程中的非线性动力学问题，实现更底层的推力分配与飞行模式控制。
*   **变构逻辑设计：**
    *   **机械原理：** “变几何下蹲”结构，机臂向内收缩 90°，导致垂直升力丧失。
    *   **控制策略：** 确立了 **“空中变构 -> 动力切断 -> 惯性着陆”** 的实验性控制逻辑。
    *   **算法路线：** 暂定采用动态混控（Dynamic Mixing）方案，通过修改 SITL 物理引擎先行验证。

### 2. WSL2 开发环境部署 (Environment Setup)
*   **系统环境：** Windows 11 + WSL2 (Ubuntu 24.04 LTS)。
*   **存储空间扩容：**
    *   **问题：** 源码编译产生大量中间文件（>20GB），导致 C 盘空间不足。
    *   **解决：** 使用 `wsl --export` 和 `wsl --import` 指令，将 Linux 子系统镜像迁移至 D 盘。
    *   **修复：** 修正迁移后默认用户变为 root 的问题，配置默认登录用户。
*   **依赖环境配置：**
    *   **Python 环境：** 解决 Ubuntu 24.04 PEP 668 (`externally-managed-environment`) 限制，使用 `--break-system-packages` 安装 `empy`, `pymavlink` 等编译依赖。
    *   **工具链：** 安装 `gcc-arm-none-eabi`, `git`, `waf` 编译工具。

### 3. 网络与开发工具配置 (Network & Tools)
*   **WSL2 网络穿透：**
    *   **问题：** WSL2 虚拟机与宿主机 IP 隔离，导致 Git 拉取超时及插件无法联网。
    *   **解决：** 编写 `.bashrc` 脚本动态获取宿主机 IP (`ip route ...`)，配置终端代理指向 Windows 端的 Clash 端口。
*   **VS Code Copilot 配置：**
    *   **问题：** 混合环境下 Copilot 无法连接服务器或无权限修改代码。
    *   **解决：** 采用“分层代理”策略。
        *   User 设置（Windows 端）：代理指向 `127.0.0.1`。
        *   Remote 设置（WSL 端）：代理指向宿主机局域网 IP。
        *   **权限修复：** 移除 `extensionKind: ui` 设置，强制插件运行在 WSL 端以获取文件写入权限。

### 4. 源码构建与闭环验证 (Build & Verification)
*   **源码获取：** 克隆 ArduPilot `Master` 分支，完成 submodule 更新。
*   **编译测试：**
    *   配置板型：`./waf configure --board sitl`
    *   编译固件：`./waf copter`
*   **"Hello WuK" 验证：**
    *   在 `ArduCopter/Copter.cpp` 初始化函数中植入打印代码。
    *   运行 `sim_vehicle.py`，成功在终端观测到自定义输出 `WARNING: WuK System is Online!`。
    *   **结论：** 确认了源码修改、编译、仿真运行的全链路已打通。

### ✅ 阶段成果
- [x] 开发环境（WSL2 + VS Code + Copilot）配置完毕且网络通畅。
- [x] ArduPilot 源码编译通过。
- [x] 仿真工具链（SITL）运行正常。

