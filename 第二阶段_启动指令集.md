

# 📄 WuK 无人机仿真标准操作手册 (SOP)

**版本：** v2.0 (3D Gazebo 版)
**环境：** Windows 11 + WSL2 (Ubuntu 24.04) + Gazebo Harmonic
**前置条件：** 已配置好 `.bashrc` 中的显卡驱动环境变量 (`d3d12`)。

### 一、 启动流程 (Routine Startup)

仿真需要两个终端窗口配合，分别运行 **物理世界 (Gazebo)** 和 **飞控大脑 (SITL)**。

#### 1. 终端 A：启动物理环境 (Gazebo)
负责渲染 3D 画面和计算物理碰撞。
```bash
# -v4: 显示详细日志
# -r: 自动开始运行(Run)，不需要手动点播放键
gz sim -v4 -r iris_runway.sdf
```
*   *成功标志：* 弹出 3D 窗口，看到跑道和飞机，操作流畅不卡顿。

#### 2. 终端 B：启动飞控系统 (SITL)
负责运行 ArduPilot 固件，连接 Gazebo。
```bash
# --model JSON: 强制使用新版通信协议
# --console: 弹出状态控制台
# --map: 弹出地图 (如果显卡压力大可去掉此参数)
cd ~/ardupilot
sim_vehicle.py -v ArduCopter --model JSON --console --map
```
*   *成功标志：* MAVProxy 终端显示 `GPS: 3D Fix`，Gazebo 里的飞机螺旋桨开始转动。

---

### 二、 常用控制指令集 (Command List)

在 **终端 B (MAVProxy)** 中输入以下指令：

#### 1. 起飞流程（guided模式）
```bash
mode guided       # 1. 切入引导模式 (电脑接管)
arm throttle      # 2. 解锁电机
takeoff 5         # 3. 起飞至 5米高度
mode land         # 4. 降落
```

#### 2. 模拟遥控器操作 (RC Override)
用于模拟打杆动作。
*   **通道定义：** 1=横滚(左右), 2=俯仰(前后), 3=油门, 4=偏航(旋转)
*   **数值范围：** 1000(低) ~ 1500(中) ~ 2000(高)
---
#### Loiter 模式（定点模式）的操作逻辑和 Stabilize（自稳）或 Guided（引导）完全不同。

**核心心法：**
*   **摇杆回中 (PWM 1500) = 悬停 (刹车/保持高度)。**
*   **摇杆推出去 = 速度指令 (向上/下/前/后飞的速度)。**

在 MAVProxy 中，你需要通过修改 RC 通道的值来模拟“推杆”和“回中”的过程。

以下是全套操作流程：

1. 准备工作

确保 GPS 已锁定（3D Fix），然后：
```bash
mode loiter
arm throttle
```
*(注意：Loiter 模式下解锁电机后，电机转速很低，飞机不会起飞，只会待机。)*

---

### 2. 起飞 (Takeoff)

在 Loiter 模式下，油门杆（通道 3）控制的是**垂直升降速度**。
*   **中位 (1500)**：保持当前高度。
*   **高位 (>1500)**：向上爬升。

**指令：**
```bash
# 1. 推油门起飞 (模拟油门推到 70%)
rc 3 1700
# 现象：飞机开始匀速上升

# 2. 到达高度后悬停 (关键！必须回中)
rc 3 1500
# 现象：飞机立刻锁住当前高度，悬停不动
```

---

### 3. 移动 (Movement)

右摇杆（通道 1 和 2）控制的是**水平移动速度**。
*   **中位 (1500)**：水平刹车/悬停。
*   **偏离中位**：以一定速度移动。

**指令：**
```bash
# 向前飞 (Pitch 推杆)
rc 2 1400  # ArduPilot默认 Pitch 低于1500是低头/前进
# 现象：飞机向前匀速飞行

# 向右飞 (Roll 打杆)
rc 1 1600
# 现象：飞机向右侧飞

# 刹车 (所有方向摇杆回中)
rc 1 1500
rc 2 1500
# 现象：飞机像踩了急刹车一样，迅速停下并定在原地
```

---

### 4. 降落 (Landing)

Loiter 模式的手动降落就是把油门拉低。

**指令：**
```bash
# 1. 开始下降 (油门拉低，模拟 30%)
rc 3 1300
# 现象：飞机匀速下降

# 2. 触地关机 (非常重要)
# 当你在画面里看到飞机接触地面后，必须立刻把油门收到 0 (1000)
rc 3 1000
# 现象：飞控检测到油门最低且不下降了，会自动上锁 (Disarm)
#或使用
mode land
```

---

### ⚠️ Loiter 模式新手大坑（必看）

在 MAVProxy 里用指令飞 Loiter，最容易犯的错误是 **“忘了回中”**。

*   **场景：** 你输了 `rc 2 1400` 让飞机往前飞，然后你去看风景了。
*   **后果：** 飞机认为你的手一直按在摇杆上，它会**一直往前飞**，直到飞出地图边界或者撞墙。
*   **解决：** 动完之后，想停下来，一定要记得输入：
    ```bash
    rc 1 1500
    rc 2 1500
    ```
    *(或者直接用 `rc all 1500`，但这会把油门也置中，导致飞机悬停，如果在降落时用这个就会重新飞起来)*

**快去试试这套“起飞 -> 1500悬停 -> 前进 -> 1500刹车 -> 降落”的流程！**

---

#### 3. 变构测试 (WuK 特有)
*前提：已在 SITL 中加载 WuK 物理模型（鸠占鹊巢法）*
```bash
servo set 9 1900  # 触发变形 (假设映射到通道9)
servo set 9 1100  # 恢复构型
```
#### 4.原地垂直降落
```bash
#原地降落
mode land
#一键返航
mode rtl
```


---

### 三、 故障排查 (Troubleshooting)

*   **问题：** Gazebo 很卡。
    *   **解法：** 检查 `glxinfo -B` 是否显示 `D3D12`。如果不显示，重启 WSL (`wsl --shutdown`)。
*   **问题：** 两边没反应，Gazebo 报错 `Magic Number`。
    *   **解法：** 确保 SITL 启动命令里加了 `--model JSON`。
*   **问题：** 飞机一直转圈停不下来。
    *   **解法：** 输入 `rc 4 1500` 回中。

