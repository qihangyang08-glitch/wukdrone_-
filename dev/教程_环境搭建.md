

# 🛠️ 环境搭建指南：从零构建 ArduPilot 开发环境

**适用系统：** Windows 11
**核心目标：** 建立基于 WSL2 (Ubuntu) 的 C++ 源码编译环境，打通网络代理，并配置 VS Code + Copilot 辅助开发。

## 1. 基础系统准备 (WSL2)

### 1.1 安装 WSL2
1.  **开启权限：** 在 Windows 搜索栏输入 `PowerShell`，右键选择 **“以管理员身份运行”**。
2.  **安装 Ubuntu：**
    ```powershell
    wsl --install
    ```
    *(如果是首次安装，系统会提示重启电脑。重启后会自动弹出安装窗口)*
3.  **初始化：** 按照提示设置用户名（如 `qwssx2`）和密码。

### 1.2 解决 C 盘空间焦虑 (关键步骤)
ArduPilot 源码编译极其占用空间 (>20GB)，建议将 Linux 系统迁移至非系统盘（如 D 盘）。

1.  **停止 WSL：** 在 PowerShell 中输入 `wsl --shutdown`。
2.  **导出镜像：**
    ```powershell
    wsl --export Ubuntu D:\ubuntu_backup.tar
    ```
3.  **注销原系统：** `wsl --unregister Ubuntu`
4.  **导入到新位置：**
    ```powershell
    # 在 D 盘创建文件夹 D:\WSL
    wsl --import Ubuntu D:\WSL D:\ubuntu_backup.tar
    ```
5.  **恢复默认用户：**
    ```powershell
    ubuntu config --default-user <你的用户名>
    ```
#### 执行完导入操作后，请进行以下检查以确保迁移成功： 
1.  打开 Windows 资源管理器，进入你指定的目录（例如 `D:\WSL`）。
2.  查找是否存在名为 **`ext4.vhdx`** 的硬盘映像文件。
    *   **成功标志：** 文件存在，且随着你安装软件，其大小会逐渐增加（初始通常几百 MB）。
    *   **注意：** 原 C 盘的 WSL 数据如果不手动注销（`--unregister`），会继续占用空间，请务必确认迁移成功后再清理。

---

## 2. 网络环境配置 (The Network)

这是最关键的一步。WSL2 与 Windows 网络隔离，且国内无法直接下载源码和连接 Copilot。

**前置条件：** 电脑上已安装并开启代理软件（如 Clash / v2rayN），记住 HTTP 代理端口（通常为 **7890**）。**必须开启“允许局域网连接 (Allow LAN)”**。

### 2.1 配置 WSL 终端代理
为了让 `git clone` 和 `apt install` 能走代理。

1.  打开 WSL 终端。
2.  编辑配置文件：`nano ~/.bashrc`
3.  在文件最末尾添加以下脚本（自动获取 Windows 的 IP）：
    ```bash
    # --- Auto Proxy Config ---
    export hostip=$(ip route show | grep default | awk '{print $3}')
    export http_proxy="http://$hostip:7890"
    export https_proxy="http://$hostip:7890"
    
    # 顺便给 git 也配上代理
    git config --global http.proxy http://$hostip:7890
    git config --global https.proxy http://$hostip:7890
    ```
4.  保存退出 (`Ctrl+O`, `Enter`, `Ctrl+X`)，然后刷新配置：`source ~/.bashrc`。

### 2.2 打通 Windows 防火墙
Windows 防火墙默认会拦截 WSL 访问宿主机的 7890 端口。

1.  Windows 搜索 **“允许应用通过 Windows 防火墙”**。
2.  点击 **“更改设置”**。
3.  找到你的代理软件（如 `Clash for Windows`），确保其后方的 **“专用”** 和 **“公用”** 两个复选框 **全部打钩**。
---
#### 配置完 `.bashrc` 和防火墙后，务必进行一次连通性测试，确保 WSL 能穿透到 Windows 代理：

在 WSL 终端输入以下指令（检测是否能访问 Google）：
```bash
# 注意：curl -v 显示详细过程
# $hostip 会自动读取你 .bashrc 里配置好的 IP 变量
curl -v -x http://$hostip:7890 http://www.google.com
```
*   **成功标志：** 终端快速返回 `HTTP/1.1 200 OK` 以及一堆 HTML 代码。
*   **失败标志：** 卡住不动超过 5 秒，或提示 `Connection timed out`。这说明 **Windows 防火墙** 依然拦截了连接，请重新检查防火墙设置中的“公用/专用”勾选。
---

## 3. 开发工具配置 (VS Code + Copilot)

### 3.1 安装 VS Code 与插件
1.  下载并安装 Windows 版 [VS Code](https://code.visualstudio.com/)。
2.  安装核心插件：
    *   **WSL** (Microsoft) —— *连接 Linux 的桥梁*
    *   **C/C++** (Microsoft) —— *代码高亮与跳转*
    *   **GitHub Copilot** & **GitHub Copilot Chat** —— *AI 辅助*
    *   **GitHub Copilot 用途**：作为我们的“AI 结对程序员”，用于**解释复杂的 ArduPilot 源码架构**、**审查代码逻辑漏洞**以及**自动生成重复性代码**。
    *   **⚠️ 核心前置条件**：Copilot 的服务器位于海外，**必须**配合代理软件（如 Clash）才能登录和生成回复。直连环境下通常会一直转圈或报错。

### 3.2 解决 Copilot 联网与权限问题 (终极方案)
为了让 Copilot 既能联网（通过 Windows 代理），又有权限修改代码（运行在 WSL 内部），采用 **“分层代理 + 强制直连”** 策略。

1.  打开 VS Code 设置 (`Ctrl + ,`)，搜索 `proxy`。
2.  在填入 Proxy 地址前，你需要知道 Windows 在 WSL 网络中的 IP 地址。
    在 WSL 终端执行：
```bash
ip route show | grep default | awk '{print $3}'
```
*   *终端会输出一串 IP（如 `172.25.160.1`），请复制这个 IP 填入 VS Code 的 Remote 设置中。*
3.  **配置【用户 (User)】标签页：**
    *   `Http: Proxy`: `http://127.0.0.1:7890` *(保证 Windows 端插件更新)*
4.  **配置【远程 (Remote) [WSL: Ubuntu]】标签页：**
    *   `Http: Proxy`: `http://172.xx.xx.1:7890` *(填入你在 WSL 里 `ip route` 查到的宿主 IP，例如 172.25.160.1)*
5.  **关键设置 (User & Remote 都要改)：**
    *   `Http: Proxy Support`: 选择 **`off`**。
    *   *原理：关闭 VS Code 自带的代理转发层，强迫插件去读我们在 `.bashrc` 里配置的系统环境变量 `http_proxy`。这是目前最稳的方案。*
6.  **重启 VS Code。**

---

## 4. 源码获取与编译环境

所有操作在 WSL 终端（或 VS Code 的集成终端）中进行。

### 4.1 获取源码
```bash
# 1. 安装 git (如果还没装)
sudo apt update && sudo apt install git -y

# 2. 克隆 ArduPilot (Master 分支)
cd ~
git clone https://github.com/ArduPilot/ardupilot.git
cd ardupilot
git submodule update --init --recursive
```

### 4.2 安装编译依赖
针对 **Ubuntu 24.04** 的特殊处理（解决 PEP 668 报错）：

```bash
# 运行官方脚本
Tools/environment_install/install-prereqs-ubuntu.sh -y

# 重新加载路径
. ~/.profile

# 补充强制安装 Python 库 (如果脚本报错)
sudo apt install python3-pip -y
python3 -m pip install empy==3.3.4 pymavlink MAVProxy pexpect future --break-system-packages
```

### 4.3 首次编译测试
```bash
# 1. 配置为 SITL 仿真板
./waf configure --board sitl

# 2. 编译多旋翼固件
./waf copter
```
*如果看到 `'build' finished successfully`，说明环境搭建完美成功。*

---
